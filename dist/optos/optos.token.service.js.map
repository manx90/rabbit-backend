{"version":3,"sources":["../../src/optos/optos.token.service.ts"],"sourcesContent":["import { Injectable, HttpException, HttpStatus } from '@nestjs/common';\nimport { HttpService } from '@nestjs/axios';\n// eslint-disable-next-line @typescript-eslint/no-require-imports\nimport FormData = require('form-data');\nimport * as dotenv from 'dotenv';\ndotenv.config({ path: '.env' });\n\n@Injectable()\nexport class OptosService {\n  constructor(private readonly httpService: HttpService) {}\n\n  async Login(): Promise<any> {\n    const clientId = process.env.CLIENT_ID;\n    const clientSecret = process.env.CLIENT_SECRET;\n    const grantType = process.env.GRANT_TYPE;\n    const username = process.env.USERNAME1;\n    const password = process.env.PASSWORD;\n    const scope = process.env.SCOPE;\n\n    if (!clientId || !clientSecret || !grantType || !username || !password) {\n      const missingVars: string[] = [];\n      if (!clientId) missingVars.push('CLIENT_ID');\n      if (!clientSecret) missingVars.push('CLIENT_SECRET');\n      if (!grantType) missingVars.push('GRANT_TYPE');\n      if (!username) missingVars.push('USERNAME');\n      if (!password) missingVars.push('PASSWORD');\n\n      throw new HttpException(\n        `Missing required environment variables: ${missingVars.join(', ')}. Please check your .env file.`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n\n    const data = new FormData();\n    data.append('grant_type', grantType);\n    data.append('client_id', clientId);\n    data.append('client_secret', clientSecret);\n    data.append('username', username);\n    data.append('password', password);\n    if (scope) {\n      data.append('scope', scope);\n    }\n\n    const urlLogin = 'https://opost.ps/oauth/token';\n\n    if (!urlLogin) {\n      throw new HttpException(\n        'URL_LOGIN configuration is missing',\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n\n    try {\n      const response = await this.httpService.axiosRef.post(\n        urlLogin.trim(),\n        data,\n        {\n          headers: {\n            Accept: 'application/json',\n            ...data.getHeaders(),\n          },\n          maxBodyLength: Infinity,\n        },\n      );\n\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      return response.data.access_token;\n    } catch (error) {\n      console.error(\n        'Error creating token:',\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n        error.response?.data || error.message,\n      );\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      if (error.response?.data?.error === 'invalid_grant') {\n        throw new HttpException(\n          'Authentication failed: Please check your username and password are correct',\n          HttpStatus.UNAUTHORIZED,\n        );\n      }\n      throw new HttpException(\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n        `Failed to create token: ${error.message}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  async userInfo(access_token: string): Promise<any> {\n    if (!access_token) {\n      throw new HttpException(\n        'Access token is required',\n        HttpStatus.BAD_REQUEST,\n      );\n    }\n\n    const urlUserInfo = 'https://opost.ps/api/oauth/user';\n\n    try {\n      const response = await this.httpService.axiosRef.get(urlUserInfo, {\n        headers: {\n          Authorization: `Bearer ${access_token}`,\n          Accept: 'application/json',\n        },\n        maxBodyLength: Infinity,\n      });\n      return response.data;\n    } catch (error) {\n      console.error(\n        'Error fetching user info:',\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n        error.response?.data || error.message,\n      );\n\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      if (error.response?.status === 401) {\n        throw new HttpException(\n          'Invalid or expired access token',\n          HttpStatus.UNAUTHORIZED,\n        );\n      }\n\n      throw new HttpException(\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n        `Failed to fetch user info: ${error.message}`,\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument, @typescript-eslint/no-unsafe-member-access\n        error.response?.status || HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"names":["OptosService","FormData","dotenv","config","path","Login","clientId","process","env","CLIENT_ID","clientSecret","CLIENT_SECRET","grantType","GRANT_TYPE","username","USERNAME1","password","PASSWORD","scope","SCOPE","missingVars","push","HttpException","join","HttpStatus","INTERNAL_SERVER_ERROR","data","append","urlLogin","response","httpService","axiosRef","post","trim","headers","Accept","getHeaders","maxBodyLength","Infinity","access_token","error","console","message","UNAUTHORIZED","userInfo","BAD_REQUEST","urlUserInfo","get","Authorization","status","constructor"],"mappings":"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"}