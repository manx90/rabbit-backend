{"version":3,"sources":["../../../src/common/utils/database-bootstrap.service.ts"],"sourcesContent":["import { Injectable, OnApplicationBootstrap } from '@nestjs/common';\r\nimport { DataSource } from 'typeorm';\r\nimport { LoggerService } from './logger.service';\r\n\r\n@Injectable()\r\nexport class DatabaseBootstrapService implements OnApplicationBootstrap {\r\n  constructor(\r\n    private readonly dataSource: DataSource,\r\n    private readonly logger: LoggerService,\r\n  ) {}\r\n\r\n  async onApplicationBootstrap(): Promise<void> {\r\n    try {\r\n      this.logger.info('Running database bootstrap checks...', 'DB_BOOTSTRAP');\r\n\r\n      // Ensure product.isManualPublishState exists\r\n      const [rows]: any[] = await this.dataSource.query(\r\n        \"SHOW COLUMNS FROM `product` LIKE 'isManualPublishState'\",\r\n      );\r\n\r\n      if (!rows || rows.length === 0) {\r\n        this.logger.warn(\r\n          'Column product.isManualPublishState missing. Adding it now...',\r\n          'DB_BOOTSTRAP',\r\n        );\r\n        await this.dataSource.query(\r\n          'ALTER TABLE `product` ADD COLUMN `isManualPublishState` TINYINT(1) NOT NULL DEFAULT 0',\r\n        );\r\n        this.logger.info(\r\n          'Added column product.isManualPublishState successfully.',\r\n          'DB_BOOTSTRAP',\r\n        );\r\n      } else {\r\n        this.logger.info(\r\n          'Column product.isManualPublishState already exists.',\r\n          'DB_BOOTSTRAP',\r\n        );\r\n      }\r\n    } catch (error) {\r\n      this.logger.logError(error as Error, 'DB_BOOTSTRAP');\r\n      // Do not throw; avoid crashing Passenger\r\n    }\r\n  }\r\n}\r\n"],"names":["DatabaseBootstrapService","onApplicationBootstrap","logger","info","rows","dataSource","query","length","warn","error","logError","constructor"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBALsC;yBACxB;+BACG;;;;;;;;;;AAGvB,IAAA,AAAMA,2BAAN,MAAMA;IAMX,MAAMC,yBAAwC;QAC5C,IAAI;YACF,IAAI,CAACC,MAAM,CAACC,IAAI,CAAC,wCAAwC;YAEzD,6CAA6C;YAC7C,MAAM,CAACC,KAAK,GAAU,MAAM,IAAI,CAACC,UAAU,CAACC,KAAK,CAC/C;YAGF,IAAI,CAACF,QAAQA,KAAKG,MAAM,KAAK,GAAG;gBAC9B,IAAI,CAACL,MAAM,CAACM,IAAI,CACd,iEACA;gBAEF,MAAM,IAAI,CAACH,UAAU,CAACC,KAAK,CACzB;gBAEF,IAAI,CAACJ,MAAM,CAACC,IAAI,CACd,2DACA;YAEJ,OAAO;gBACL,IAAI,CAACD,MAAM,CAACC,IAAI,CACd,uDACA;YAEJ;QACF,EAAE,OAAOM,OAAO;YACd,IAAI,CAACP,MAAM,CAACQ,QAAQ,CAACD,OAAgB;QACrC,yCAAyC;QAC3C;IACF;IApCAE,YACE,AAAiBN,UAAsB,EACvC,AAAiBH,MAAqB,CACtC;aAFiBG,aAAAA;aACAH,SAAAA;IAChB;AAkCL"}