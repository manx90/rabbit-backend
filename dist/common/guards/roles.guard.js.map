{"version":3,"sources":["../../../src/common/guards/roles.guard.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unnecessary-type-assertion */\r\nimport {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { ROLES_KEY } from '../decorators/roles.decorator';\r\nimport { Role } from '../constants/roles.constant';\r\n\r\ninterface RequestWithUser extends Request {\r\n  user?: { role?: Role };\r\n}\r\n\r\n@Injectable()\r\nexport class RolesGuard implements CanActivate {\r\n  constructor(private readonly reflector: Reflector) {}\r\n\r\n  canActivate(context: ExecutionContext): boolean {\r\n    // Get the roles required by the route (@Roles(...))\r\n    const requiredRoles = this.reflector.getAllAndOverride<Role[]>(ROLES_KEY, [\r\n      context.getHandler(),\r\n      context.getClass(),\r\n    ]);\r\n\r\n    // Public route if no roles specified\r\n    if (!requiredRoles || requiredRoles.length === 0) return true;\r\n\r\n    // Extract user from request\r\n    const request = context.switchToHttp().getRequest<RequestWithUser>();\r\n    const userRole = request.user?.role as Role | undefined;\r\n    console.log(userRole);\r\n    if (!userRole) {\r\n      throw new ForbiddenException(\r\n        'User role was not found in request context',\r\n      );\r\n    }\r\n\r\n    // Authorize: user must match at least one required role\r\n    const allowed = requiredRoles.includes(userRole);\r\n    if (!allowed) {\r\n      throw new ForbiddenException(\r\n        'You do not have the required role to access this resource',\r\n      );\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n"],"names":["RolesGuard","canActivate","context","request","requiredRoles","reflector","getAllAndOverride","ROLES_KEY","getHandler","getClass","length","switchToHttp","getRequest","userRole","user","role","console","log","ForbiddenException","allowed","includes","constructor"],"mappings":"AAAA,mEAAmE;;;;+BAgBtDA;;;eAAAA;;;wBAVN;sBACmB;gCACA;;;;;;;;;;AAQnB,IAAA,AAAMA,aAAN,MAAMA;IAGXC,YAAYC,OAAyB,EAAW;YAY7BC;QAXjB,oDAAoD;QACpD,MAAMC,gBAAgB,IAAI,CAACC,SAAS,CAACC,iBAAiB,CAASC,yBAAS,EAAE;YACxEL,QAAQM,UAAU;YAClBN,QAAQO,QAAQ;SACjB;QAED,qCAAqC;QACrC,IAAI,CAACL,iBAAiBA,cAAcM,MAAM,KAAK,GAAG,OAAO;QAEzD,4BAA4B;QAC5B,MAAMP,UAAUD,QAAQS,YAAY,GAAGC,UAAU;QACjD,MAAMC,YAAWV,gBAAAA,QAAQW,IAAI,cAAZX,oCAAAA,cAAcY,IAAI;QACnCC,QAAQC,GAAG,CAACJ;QACZ,IAAI,CAACA,UAAU;YACb,MAAM,IAAIK,0BAAkB,CAC1B;QAEJ;QAEA,wDAAwD;QACxD,MAAMC,UAAUf,cAAcgB,QAAQ,CAACP;QACvC,IAAI,CAACM,SAAS;YACZ,MAAM,IAAID,0BAAkB,CAC1B;QAEJ;QAEA,OAAO;IACT;IA/BAG,YAAY,AAAiBhB,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AAgCtD"}