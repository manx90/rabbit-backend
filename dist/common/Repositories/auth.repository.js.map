{"version":3,"sources":["../../../src/common/Repositories/auth.repository.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-member-access */\r\nimport {\r\n  Injectable,\r\n  NotFoundException,\r\n  InternalServerErrorException,\r\n  ConflictException,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { InjectRepository } from '@nestjs/typeorm';\r\nimport { Repository } from 'typeorm';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport * as bcrypt from 'bcrypt';\r\n\r\nimport { auth } from '../../auth/entities/auth.entity';\r\nimport { AuthUser } from '../../auth/dto/auth.dto';\r\nimport { Role } from '../constants/roles.constant';\r\nimport { UpdateUserDto } from 'src/auth/dto/update-user.dto';\r\n\r\n@Injectable()\r\nexport class AuthRepository {\r\n  private readonly logger = new Logger(AuthRepository.name);\r\n\r\n  constructor(\r\n    @InjectRepository(auth)\r\n    private readonly authRepository: Repository<auth>,\r\n    private readonly jwtService: JwtService,\r\n  ) {}\r\n\r\n  /** Update user by ID */\r\n  async update(userId: string, updateUserDto: UpdateUserDto): Promise<auth> {\r\n    const user = await this.findById(userId);\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // تحديث خصائص المستخدم بالبيانات الجديدة من updateUserDto\r\n    Object.assign(user, updateUserDto);\r\n\r\n    try {\r\n      return await this.authRepository.save(user);\r\n    } catch (error: any) {\r\n      this.logger.error(`Error updating user: ${error.message}`, error.stack);\r\n      throw new InternalServerErrorException('Failed to update user');\r\n    }\r\n  }\r\n\r\n  /** Find a user by username */\r\n  async findOne(username: string): Promise<auth | null> {\r\n    try {\r\n      return await this.authRepository.findOne({ where: { username } });\r\n    } catch (error: any) {\r\n      this.logger.error(`Error finding user: ${error.message}`, error.stack);\r\n      throw new InternalServerErrorException('Error finding user');\r\n    }\r\n  }\r\n\r\n  /** Find a user by ID */\r\n  async findById(id: string): Promise<auth | null> {\r\n    try {\r\n      return await this.authRepository.findOne({ where: { id } });\r\n    } catch (error: any) {\r\n      this.logger.error(\r\n        `Error finding user by ID: ${error.message}`,\r\n        error.stack,\r\n      );\r\n      throw new InternalServerErrorException('Error finding user');\r\n    }\r\n  }\r\n\r\n  /** Save a new user */\r\n  async save(user: AuthUser): Promise<auth> {\r\n    const exists = await this.findOne(user.username);\r\n    if (exists) {\r\n      throw new ConflictException('Username already taken');\r\n    }\r\n\r\n    const saltRounds = Number(process.env.SALT) || 10;\r\n    const hashed = await bcrypt.hash(user.password, saltRounds);\r\n\r\n    const entity = new auth();\r\n    entity.username = user.username;\r\n    entity.password = hashed;\r\n    entity.role = user.role ?? Role.Salesman;\r\n\r\n    try {\r\n      return await this.authRepository.save(entity);\r\n    } catch (error: any) {\r\n      this.logger.error(`Error saving user: ${error.message}`, error.stack);\r\n      throw new InternalServerErrorException('Failed to create user');\r\n    }\r\n  }\r\n\r\n  /** Validate credentials */\r\n  async validateUser(username: string, password: string): Promise<auth | null> {\r\n    const user = await this.findOne(username);\r\n    if (!user) return null;\r\n    const valid = await bcrypt.compare(password, user.password);\r\n    return valid ? user : null;\r\n  }\r\n\r\n  /** Generate JWT token */\r\n  generateToken(user: auth): { access_token: string } {\r\n    const payload = { username: user.username, sub: user.id, role: user.role };\r\n    return { access_token: this.jwtService.sign(payload) };\r\n  }\r\n\r\n  /** Update password */\r\n  async updatePassword(id: string, newPwd: string): Promise<auth> {\r\n    const user = await this.findById(id);\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n    const saltRounds = Number(process.env.SALT) || 10;\r\n    user.password = await bcrypt.hash(newPwd, saltRounds);\r\n    return this.authRepository.save(user);\r\n  }\r\n\r\n  /** Delete all users */\r\n  async deleteAll(): Promise<void> {\r\n    await this.authRepository.clear();\r\n  }\r\n\r\n  /** Get all users */\r\n  async getAll(): Promise<auth[]> {\r\n    return this.authRepository.find();\r\n  }\r\n\r\n  /** Delete one user by username */\r\n  async deleteOne(username: string): Promise<void> {\r\n    const user = await this.findOne(username);\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n    await this.authRepository.delete({ username });\r\n  }\r\n}\r\n"],"names":["AuthRepository","update","userId","updateUserDto","user","findById","NotFoundException","Object","assign","authRepository","save","error","logger","message","stack","InternalServerErrorException","findOne","username","where","id","exists","ConflictException","saltRounds","Number","process","env","SALT","hashed","bcrypt","hash","password","entity","auth","role","Role","Salesman","validateUser","valid","compare","generateToken","payload","sub","access_token","jwtService","sign","updatePassword","newPwd","deleteAll","clear","getAll","find","deleteOne","delete","constructor","Logger","name"],"mappings":"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"}