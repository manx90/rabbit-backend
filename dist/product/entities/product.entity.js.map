{"version":3,"sources":["../../../src/product/entities/product.entity.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-member-access */\r\n/* eslint-disable @typescript-eslint/no-unsafe-call */\r\n/* eslint-disable @typescript-eslint/no-unsafe-return */\r\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\r\nimport { Transform } from 'class-transformer';\r\nimport { auth } from 'src/auth/entities/auth.entity';\r\nimport {\r\n  AfterInsert,\r\n  AfterLoad,\r\n  AfterUpdate,\r\n  BeforeInsert,\r\n  BeforeUpdate,\r\n  Column,\r\n  Entity,\r\n  JoinColumn,\r\n  ManyToOne,\r\n  PrimaryGeneratedColumn,\r\n} from 'typeorm';\r\nimport {\r\n  ColorDetail,\r\n  PublishState,\r\n  SizeDetail,\r\n} from '../../common/interfaces/entity.interface';\r\nimport { category, subCategory } from './Category.entity';\r\n\r\nexport interface ProductResponse {\r\n  id: number;\r\n  name: string;\r\n  description: string;\r\n  price: number;\r\n  sizes: string[];\r\n  colors: string[];\r\n  isActive: boolean;\r\n  PosterAt: Date | null;\r\n}\r\n\r\nexport enum Season {\r\n  winter = 'winter',\r\n  summer = 'summer',\r\n  spring_autumn = 'spring_autumn',\r\n  all = 'all',\r\n}\r\n\r\n@Entity()\r\nexport class product {\r\n  @PrimaryGeneratedColumn()\r\n  id: number;\r\n\r\n  @Column({ type: 'varchar', length: 255 })\r\n  name: string;\r\n\r\n  @Column({\r\n    type: 'enum',\r\n    enum: Season,\r\n    default: Season.all,\r\n    nullable: true,\r\n  })\r\n  season: Season;\r\n\r\n  @Column({\r\n    type: 'simple-array',\r\n    nullable: true,\r\n  })\r\n  @Transform(({ value }) => {\r\n    const newVal = value?.map((item) => item.trim());\r\n    return newVal;\r\n  })\r\n  wordKeys: string[];\r\n\r\n  @Column({ type: 'longtext', nullable: true })\r\n  videoLink: string;\r\n\r\n  @Column({ type: 'text', nullable: true })\r\n  description: string;\r\n\r\n  @Column({ type: 'json', nullable: true })\r\n  images: string[];\r\n\r\n  @Column({ type: 'simple-array', nullable: true })\r\n  productIdsCollection: number[];\r\n\r\n  @Column({ type: 'longtext', nullable: true })\r\n  imgCover: string;\r\n\r\n  @Column({ type: 'longtext', nullable: true })\r\n  imgSizeChart: string;\r\n\r\n  @Column({ type: 'longtext', nullable: true })\r\n  imgMeasure: string;\r\n\r\n  @Column({ type: 'json' })\r\n  sizeDetails: SizeDetail[];\r\n\r\n  @Column({\r\n    type: 'enum',\r\n    enum: PublishState,\r\n    default: PublishState.PUBLISHED,\r\n  })\r\n  publishState: PublishState;\r\n\r\n  @Column({ type: 'boolean', default: false, nullable: true })\r\n  isManualPublishState?: boolean;\r\n\r\n  @Column({ type: 'json', nullable: true })\r\n  colors: ColorDetail[];\r\n\r\n  @ManyToOne(() => category, (category) => category.products)\r\n  @JoinColumn({ name: 'categoryId' })\r\n  category: { id: number; name: string };\r\n\r\n  @ManyToOne(() => subCategory, (subCategory) => subCategory.products, {\r\n    onDelete: 'CASCADE',\r\n  })\r\n  @JoinColumn({ name: 'subCategoryId' })\r\n  subCategory: subCategory;\r\n\r\n  @ManyToOne(() => auth, { nullable: true })\r\n  @JoinColumn({ name: 'posterId' })\r\n  poster: { id: string; username: string };\r\n\r\n  @Column({ type: 'decimal', default: null })\r\n  quantity: number;\r\n\r\n  @Column({ type: 'boolean', default: false })\r\n  isFeatured: boolean;\r\n\r\n  @Column({ type: 'boolean', default: false })\r\n  isTrending: boolean;\r\n\r\n  @Column({ type: 'boolean', default: true })\r\n  isNew: boolean;\r\n\r\n  @Column({ type: 'boolean', default: false })\r\n  isBestSeller: boolean;\r\n\r\n  @Column({ type: 'boolean', default: false })\r\n  isDeleted: boolean;\r\n\r\n  @Column({ type: 'int', default: 0 })\r\n  sales: number;\r\n\r\n  @Column({\r\n    type: 'timestamp',\r\n    default: null,\r\n    nullable: true,\r\n  })\r\n  datePublished: Date;\r\n\r\n  @Column({ type: 'timestamp', default: () => 'CURRENT_TIMESTAMP' })\r\n  createdAt: Date;\r\n\r\n  @Column({ type: 'timestamp', default: null, nullable: true })\r\n  PosterAt: Date;\r\n\r\n  @Column({ type: 'timestamp', default: null, nullable: true })\r\n  updatedAt: Date;\r\n  Product: { id: string; username: string };\r\n\r\n  /**\r\n   * Calculate total quantity from all sizes and colors\r\n   */\r\n  getTotalQuantity(): number {\r\n    if (!this.sizeDetails) return 0;\r\n\r\n    return this.sizeDetails.reduce((total, size) => {\r\n      const sizeTotal = size.quantities.reduce((sizeSum, colorQty) => {\r\n        return sizeSum + colorQty.quantity;\r\n      }, 0);\r\n      return total + sizeTotal;\r\n    }, 0);\r\n  }\r\n\r\n  /**\r\n   * Get all available colors from all sizes\r\n   */\r\n  getAvailableColors(): Array<{ name: string; imgColor?: string }> {\r\n    if (!this.sizeDetails) return [];\r\n\r\n    const colorsMap = new Map<string, string>();\r\n\r\n    this.sizeDetails.forEach((size) => {\r\n      size.quantities.forEach((colorQty) => {\r\n        if (colorQty.quantity > 0) {\r\n          colorsMap.set(colorQty.colorName, '');\r\n        }\r\n      });\r\n    });\r\n\r\n    return Array.from(colorsMap.entries()).map(([name, imgColor]) => ({\r\n      name,\r\n      imgColor,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Get all available sizes\r\n   */\r\n  getAvailableSizes(): string[] {\r\n    if (!this.sizeDetails) return [];\r\n\r\n    return this.sizeDetails\r\n      .filter((size) => size.quantities.some((q) => q.quantity > 0))\r\n      .map((size) => size.sizeName);\r\n  }\r\n\r\n  // schedule publish\r\n  @AfterLoad()\r\n  @AfterInsert()\r\n  @AfterUpdate()\r\n  updatePublishState() {\r\n    // Skip automatic state update if manually set (only if column exists)\r\n    if (this.isManualPublishState === true) {\r\n      return;\r\n    }\r\n\r\n    if (this.datePublished && this.datePublished > new Date()) {\r\n      this.publishState = PublishState.DRAFT;\r\n    } else {\r\n      this.publishState = PublishState.PUBLISHED;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Before insert hook - validate size details\r\n   */\r\n  @BeforeInsert()\r\n  @BeforeUpdate()\r\n  validateSizeDetails() {\r\n    if (!this.sizeDetails || this.sizeDetails.length === 0) {\r\n      throw new Error('Product must have at least one size detail');\r\n    }\r\n\r\n    this.sizeDetails.forEach((size) => {\r\n      if (!size.sizeName || size.price <= 0) {\r\n        throw new Error('Each size must have a valid name and price');\r\n      }\r\n\r\n      if (!size.quantities || size.quantities.length === 0) {\r\n        throw new Error('Each size must have at least one color quantity');\r\n      }\r\n\r\n      size.quantities.forEach((colorQty) => {\r\n        if (!colorQty.colorName || colorQty.quantity < 0) {\r\n          throw new Error(\r\n            'Each color quantity must have a valid color name and non-negative quantity',\r\n          );\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Before insert hook - validate size details\r\n   */\r\n  @BeforeInsert()\r\n  @BeforeUpdate()\r\n  validateTotalQuantity() {\r\n    if (!this.sizeDetails) return;\r\n\r\n    const totalQuantity = this.sizeDetails.reduce(\r\n      (total, size) =>\r\n        total +\r\n        size.quantities.reduce((sum, colorQty) => sum + colorQty.quantity, 0),\r\n      0,\r\n    );\r\n\r\n    this.quantity = totalQuantity;\r\n  }\r\n}\r\n"],"names":["Season","product","getTotalQuantity","sizeDetails","reduce","total","size","sizeTotal","quantities","sizeSum","colorQty","quantity","getAvailableColors","colorsMap","Map","forEach","set","colorName","Array","from","entries","map","name","imgColor","getAvailableSizes","filter","some","q","sizeName","updatePublishState","isManualPublishState","datePublished","Date","publishState","PublishState","DRAFT","PUBLISHED","validateSizeDetails","length","Error","price","validateTotalQuantity","totalQuantity","sum","type","enum","default","nullable","value","newVal","item","trim","category","products","subCategory","onDelete","auth"],"mappings":"AAAA,6DAA6D,GAC7D,oDAAoD,GACpD,sDAAsD,GACtD,0DAA0D;;;;;;;;;;;IAiC9CA,MAAM;eAANA;;IAQCC,OAAO;eAAPA;;;kCAxCa;4BACL;yBAYd;iCAKA;gCAC+B;;;;;;;;;;AAa/B,IAAA,AAAKD,gCAAAA;;;;;WAAAA;;AAQL,IAAA,AAAMC,UAAN,MAAMA;IAkHX;;GAEC,GACDC,mBAA2B;QACzB,IAAI,CAAC,IAAI,CAACC,WAAW,EAAE,OAAO;QAE9B,OAAO,IAAI,CAACA,WAAW,CAACC,MAAM,CAAC,CAACC,OAAOC;YACrC,MAAMC,YAAYD,KAAKE,UAAU,CAACJ,MAAM,CAAC,CAACK,SAASC;gBACjD,OAAOD,UAAUC,SAASC,QAAQ;YACpC,GAAG;YACH,OAAON,QAAQE;QACjB,GAAG;IACL;IAEA;;GAEC,GACDK,qBAAiE;QAC/D,IAAI,CAAC,IAAI,CAACT,WAAW,EAAE,OAAO,EAAE;QAEhC,MAAMU,YAAY,IAAIC;QAEtB,IAAI,CAACX,WAAW,CAACY,OAAO,CAAC,CAACT;YACxBA,KAAKE,UAAU,CAACO,OAAO,CAAC,CAACL;gBACvB,IAAIA,SAASC,QAAQ,GAAG,GAAG;oBACzBE,UAAUG,GAAG,CAACN,SAASO,SAAS,EAAE;gBACpC;YACF;QACF;QAEA,OAAOC,MAAMC,IAAI,CAACN,UAAUO,OAAO,IAAIC,GAAG,CAAC,CAAC,CAACC,MAAMC,SAAS,GAAM,CAAA;gBAChED;gBACAC;YACF,CAAA;IACF;IAEA;;GAEC,GACDC,oBAA8B;QAC5B,IAAI,CAAC,IAAI,CAACrB,WAAW,EAAE,OAAO,EAAE;QAEhC,OAAO,IAAI,CAACA,WAAW,CACpBsB,MAAM,CAAC,CAACnB,OAASA,KAAKE,UAAU,CAACkB,IAAI,CAAC,CAACC,IAAMA,EAAEhB,QAAQ,GAAG,IAC1DU,GAAG,CAAC,CAACf,OAASA,KAAKsB,QAAQ;IAChC;IAEA,mBAAmB;IAInBC,qBAAqB;QACnB,sEAAsE;QACtE,IAAI,IAAI,CAACC,oBAAoB,KAAK,MAAM;YACtC;QACF;QAEA,IAAI,IAAI,CAACC,aAAa,IAAI,IAAI,CAACA,aAAa,GAAG,IAAIC,QAAQ;YACzD,IAAI,CAACC,YAAY,GAAGC,6BAAY,CAACC,KAAK;QACxC,OAAO;YACL,IAAI,CAACF,YAAY,GAAGC,6BAAY,CAACE,SAAS;QAC5C;IACF;IAEA;;GAEC,GACD,AAEAC,sBAAsB;QACpB,IAAI,CAAC,IAAI,CAAClC,WAAW,IAAI,IAAI,CAACA,WAAW,CAACmC,MAAM,KAAK,GAAG;YACtD,MAAM,IAAIC,MAAM;QAClB;QAEA,IAAI,CAACpC,WAAW,CAACY,OAAO,CAAC,CAACT;YACxB,IAAI,CAACA,KAAKsB,QAAQ,IAAItB,KAAKkC,KAAK,IAAI,GAAG;gBACrC,MAAM,IAAID,MAAM;YAClB;YAEA,IAAI,CAACjC,KAAKE,UAAU,IAAIF,KAAKE,UAAU,CAAC8B,MAAM,KAAK,GAAG;gBACpD,MAAM,IAAIC,MAAM;YAClB;YAEAjC,KAAKE,UAAU,CAACO,OAAO,CAAC,CAACL;gBACvB,IAAI,CAACA,SAASO,SAAS,IAAIP,SAASC,QAAQ,GAAG,GAAG;oBAChD,MAAM,IAAI4B,MACR;gBAEJ;YACF;QACF;IACF;IAEA;;GAEC,GACD,AAEAE,wBAAwB;QACtB,IAAI,CAAC,IAAI,CAACtC,WAAW,EAAE;QAEvB,MAAMuC,gBAAgB,IAAI,CAACvC,WAAW,CAACC,MAAM,CAC3C,CAACC,OAAOC,OACND,QACAC,KAAKE,UAAU,CAACJ,MAAM,CAAC,CAACuC,KAAKjC,WAAaiC,MAAMjC,SAASC,QAAQ,EAAE,IACrE;QAGF,IAAI,CAACA,QAAQ,GAAG+B;IAClB;AACF;;;;;;;QA5NYE,MAAM;QAAWN,QAAQ;;;;;;QAIjCM,MAAM;QACNC,MAAM7C;QACN8C,OAAO;QACPC,UAAU;;;;;;QAKVH,MAAM;QACNG,UAAU;;sCAEA,EAAEC,KAAK,EAAE;QACnB,MAAMC,SAASD,kBAAAA,4BAAAA,MAAO3B,GAAG,CAAC,CAAC6B,OAASA,KAAKC,IAAI;QAC7C,OAAOF;IACT;;;;;QAGUL,MAAM;QAAYG,UAAU;;;;;;QAG5BH,MAAM;QAAQG,UAAU;;;;;;QAGxBH,MAAM;QAAQG,UAAU;;;;;;QAGxBH,MAAM;QAAgBG,UAAU;;;;;;QAGhCH,MAAM;QAAYG,UAAU;;;;;;QAG5BH,MAAM;QAAYG,UAAU;;;;;;QAG5BH,MAAM;QAAYG,UAAU;;;;;;QAG5BH,MAAM;;;;;;QAIdA,MAAM;QACNC,MAAMX,6BAAY;QAClBY,SAASZ,6BAAY,CAACE,SAAS;;;;;;QAIvBQ,MAAM;QAAWE,SAAS;QAAOC,UAAU;;;;;;QAG3CH,MAAM;QAAQG,UAAU;;;;;gCAGjBK,wBAAQ,GAAGA,WAAaA,SAASC,QAAQ;;QAC5C/B,MAAM;;;;;gCAGHgC,2BAAW,GAAGA,cAAgBA,YAAYD,QAAQ;QACjEE,UAAU;;;QAEEjC,MAAM;;;;;gCAGHkC,gBAAI;QAAIT,UAAU;;;QACrBzB,MAAM;;;;;;QAGVsB,MAAM;QAAWE,SAAS;;;;;;QAG1BF,MAAM;QAAWE,SAAS;;;;;;QAG1BF,MAAM;QAAWE,SAAS;;;;;;QAG1BF,MAAM;QAAWE,SAAS;;;;;;QAG1BF,MAAM;QAAWE,SAAS;;;;;;QAG1BF,MAAM;QAAWE,SAAS;;;;;;QAG1BF,MAAM;QAAOE,SAAS;;;;;;QAI9BF,MAAM;QACNE,SAAS;QACTC,UAAU;;;;;;QAIFH,MAAM;QAAaE,SAAS,IAAM;;;;;;QAGlCF,MAAM;QAAaE,SAAS;QAAMC,UAAU;;;;;;QAG5CH,MAAM;QAAaE,SAAS;QAAMC,UAAU"}