{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import { NestFactory } from '@nestjs/core';\r\nimport { AppModule } from './app.module';\r\nimport * as bodyParser from 'body-parser';\r\nimport { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';\r\nimport { ValidationPipe } from '@nestjs/common';\r\nimport { LoggerMiddleware } from './common/middleware/logger.middleware';\r\nimport { NestExpressApplication } from '@nestjs/platform-express';\r\nimport { join } from 'path';\r\nimport { ValidationExceptionFilter } from './common/filters/validation-exception.filter';\r\nimport { NotFoundExceptionFilter } from './common/filters/not-found-exception.filter';\r\nimport { AllExceptionsFilter } from './common/filters/all-exceptions.filter';\r\nimport { LoggerService } from './common/utils/logger.service';\r\n\r\n// import dataSource from './data-source';\r\nconst logger = new LoggerService();\r\n\r\n// Memory optimization for cPanel hosting\r\nif (process.env.NODE_ENV === 'production') {\r\n  // Force garbage collection more frequently\r\n  setInterval(() => {\r\n    if (global.gc) {\r\n      global.gc();\r\n    }\r\n  }, 30000); // Every 30 seconds\r\n\r\n  // Monitor memory usage\r\n  setInterval(() => {\r\n    const memUsage = process.memoryUsage();\r\n    const memUsageMB = Math.round(memUsage.heapUsed / 1024 / 1024);\r\n    if (memUsageMB > 50) {\r\n      // If using more than 50MB\r\n      logger.warn(`High memory usage: ${memUsageMB}MB`, 'MEMORY');\r\n      if (global.gc) {\r\n        global.gc();\r\n        const newUsage = Math.round(\r\n          process.memoryUsage().heapUsed / 1024 / 1024,\r\n        );\r\n        logger.info(`Memory after GC: ${newUsage}MB`, 'MEMORY');\r\n      }\r\n    }\r\n  }, 60000); // Check every minute\r\n}\r\n\r\n// Global error handlers for uncaught exceptions and unhandled promise rejections\r\nprocess.on('uncaughtException', (error: Error) => {\r\n  logger.logError(error, 'UNCAUGHT_EXCEPTION', {\r\n    type: 'uncaughtException',\r\n    timestamp: new Date().toISOString(),\r\n    pid: process.pid,\r\n  });\r\n  console.error('Uncaught Exception:', error);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('unhandledRejection', (reason: any, promise: Promise<any>) => {\r\n  const error = reason instanceof Error ? reason : new Error(String(reason));\r\n  logger.logError(error, 'UNHANDLED_REJECTION', {\r\n    type: 'unhandledRejection',\r\n    timestamp: new Date().toISOString(),\r\n    pid: process.pid,\r\n    promise: promise.toString(),\r\n  });\r\n  console.error('Unhandled Rejection:', reason);\r\n  process.exit(1);\r\n});\r\n\r\nprocess.on('SIGTERM', () => {\r\n  logger.info('SIGTERM received, shutting down gracefully', 'PROCESS');\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  logger.info('SIGINT received, shutting down gracefully', 'PROCESS');\r\n  process.exit(0);\r\n});\r\n\r\n(async () => {\r\n  try {\r\n    logger.info('Starting application bootstrap...', 'Bootstrap');\r\n\r\n    // Optimize for production environment\r\n    const isProduction = process.env.NODE_ENV === 'production';\r\n\r\n    const app = await NestFactory.create<NestExpressApplication>(AppModule, {\r\n      // Reduce memory usage for cPanel hosting\r\n      logger: isProduction\r\n        ? ['error', 'warn']\r\n        : ['log', 'error', 'warn', 'debug'],\r\n      // Disable unnecessary features to save memory\r\n      bufferLogs: false,\r\n      abortOnError: false,\r\n    });\r\n\r\n    logger.info('Application created successfully', 'Bootstrap');\r\n\r\n    // Configure static file serving for uploads\r\n    app.useStaticAssets(join(__dirname, '..', 'uploads'), {\r\n      prefix: '/uploads',\r\n    });\r\n\r\n    // await dataSource.initialize();\r\n    // await dataSource.runMigrations();\r\n\r\n    // Only enable Swagger in development\r\n    if (!isProduction) {\r\n      const config = new DocumentBuilder()\r\n        .setTitle('rabbit')\r\n        .setDescription('The rabbit API description')\r\n        .setVersion('1.0')\r\n        .addBearerAuth() // Add Bearer Auth to Swagger\r\n        .build();\r\n      const documentFactory = () => SwaggerModule.createDocument(app, config);\r\n      SwaggerModule.setup('api', app, documentFactory);\r\n    }\r\n\r\n    // Reduce body parser limits to save memory for cPanel\r\n    const bodyLimit = isProduction ? '5mb' : '50mb';\r\n    app.use(\r\n      bodyParser.json({\r\n        limit: bodyLimit,\r\n        // Reduce memory usage\r\n        verify: undefined,\r\n        type: 'application/json',\r\n      }),\r\n    );\r\n    app.use(\r\n      bodyParser.urlencoded({\r\n        extended: false, // Use false instead of true to save memory\r\n        limit: bodyLimit,\r\n        parameterLimit: 1000, // Limit number of parameters\r\n      }),\r\n    );\r\n\r\n    app.use(LoggerMiddleware);\r\n    app.enableCors({\r\n      origin: '*',\r\n      methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',\r\n      credentials: false,\r\n    });\r\n    app.useGlobalPipes(\r\n      new ValidationPipe({\r\n        transform: true,\r\n        transformOptions: {\r\n          enableImplicitConversion: true, // <- This line here\r\n        },\r\n        whitelist: true,\r\n        forbidNonWhitelisted: true,\r\n      }),\r\n    );\r\n\r\n    // Apply global exception filters\r\n    app.useGlobalFilters(\r\n      new AllExceptionsFilter(new LoggerService()),\r\n      new ValidationExceptionFilter(),\r\n      new NotFoundExceptionFilter(),\r\n    );\r\n\r\n    logger.info('Starting server...', 'Bootstrap');\r\n    await app.listen(process.env.PORT ?? 3000, '0.0.0.0');\r\n    logger.info(\r\n      `Application is running on: http://0.0.0.0:${process.env.PORT ?? 3000}`,\r\n      'Bootstrap',\r\n    );\r\n  } catch (error) {\r\n    logger.logError(error, 'Bootstrap');\r\n    process.exit(1);\r\n  }\r\n})();\r\n"],"names":["logger","LoggerService","process","env","NODE_ENV","setInterval","global","gc","memUsage","memoryUsage","memUsageMB","Math","round","heapUsed","warn","newUsage","info","on","error","logError","type","timestamp","Date","toISOString","pid","console","exit","reason","promise","Error","String","toString","isProduction","app","NestFactory","create","AppModule","bufferLogs","abortOnError","useStaticAssets","join","__dirname","prefix","config","DocumentBuilder","setTitle","setDescription","setVersion","addBearerAuth","build","documentFactory","SwaggerModule","createDocument","setup","bodyLimit","use","bodyParser","json","limit","verify","undefined","urlencoded","extended","parameterLimit","LoggerMiddleware","enableCors","origin","methods","credentials","useGlobalPipes","ValidationPipe","transform","transformOptions","enableImplicitConversion","whitelist","forbidNonWhitelisted","useGlobalFilters","AllExceptionsFilter","ValidationExceptionFilter","NotFoundExceptionFilter","listen","PORT"],"mappings":"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"}